<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
	<title>用户登录 - {$maccms.site_name}</title>
  <meta name="keywords" content="{$maccms.site_keywords}" />
  <meta name="description" content="{$maccms.site_description}" />
  {include file="public/header-include"}
  <link rel="stylesheet" href="{$maccms.path_tpl}static/lib/intlTelInput/intlTelInput.min.css">
  <link rel="stylesheet" href="{$maccms.path_tpl}static/css/register.css">
</head>

<body>
  <div class="container">
    <!-- 注册 主体content -->
    <div class="register login">
      <div class="jsTab login-tab">
        <div class="jsTabItem login-tab-item" data-type="phone">
          手机账号登录
        </div>
        <div class="jsTabItem login-tab-item active" data-type="account">
          账号登录
        </div>
      </div>

      <div id="login_phone" class="jsWrap register-wrap" style="display: none;">
        <form method="post" id="fm_phone" action="">
          <div class="register-form-group">
            <div class="form-group clearfix">
              <input type="tel" id="phone" name="user_phone" class="user-phone">
            </div>
            <div class="form-group clearfix">
              <img src="{$maccms.path_tpl}static/image/icon_password.png" alt="密码">
              <input type="password" id="pass1" name="user_phone_pwd" placeholder="密码6-16位字母 数字或者符号">
            </div>
            {if condition="$GLOBALS['config']['user']['login_verify'] eq 1"}
            <div class="form-group clearfix">
              <img src="{$maccms.path_tpl}static/image/icon_code.png" alt="验证码">
              <input id="inputCode" type="text" name="phone_verify" placeholder="请输入验证码">
              <!-- <div id="checkCode" class="check-code" onclick="createCode(4)"></div> -->
			        <div id="checkCode" class="check-code pwd_img"><img id="verify_img_phone" src="{:url('verify/index')}" onClick="this.src=this.src+'?'+Math.random()" /></div>
            </div>
            {/if}
          </div>
          <input type="button" id="btn_submit_phone" class="btn-brand" value="登录">
        </form>
        <div class="register-agreement">
          <a class="btn-white log-reg" href="{:url('user/reg')}">注册账号</a>
        </div>
      </div>


      <div id="login_account" class="jsWrap register-wrap">
        <form method="post" id="fm" action="">
          <div class="register-form-group">
            <div class="form-group clearfix">
              <img src="{$maccms.path_tpl}static/image/icon_account.png" alt="账号">
              <input type="text" name="user_name" placeholder="请输入账号">
            </div>
            <div class="form-group clearfix">
              <img src="{$maccms.path_tpl}static/image/icon_password.png" alt="密码">
              <input type="password" id="pass1" name="user_pwd" placeholder="请输入密码">
            </div>
            {if condition="$GLOBALS['config']['user']['login_verify'] eq 1"}
            <div class="form-group clearfix">
              <img src="{$maccms.path_tpl}static/image/icon_code.png" alt="验证码">
              <input id="inputCode" type="text" name="verify" placeholder="请输入验证码">
              <!-- <div id="checkCode" class="check-code" onclick="createCode(4)"></div> -->
			        <div id="checkCode" class="check-code pwd_img"><img id="verify_img" src="{:url('verify/index')}" onClick="this.src=this.src+'?'+Math.random()" /></div>
            </div>
            {/if}
            
          </div>
          <input type="button" id="btn_submit" class="btn-brand" value="登录">
        </form>
        <div class="register-agreement">
          <a class="btn-white log-reg" href="{:url('user/reg')}">注册账号</a>
		      <!-- <a class="a-gry" href="{:url('user/findpass')}">找回密码</a> -->
        </div>
      </div>


    </div>

    <!-- 注册 主体content -->

  </div>

  {include file="public/footer-include"}
  <script src="{$maccms.path_tpl}static/lib/intlTelInput/intlTelInput.min.js"></script>

  <script>
    var inputPhone = document.querySelector("#phone");
    var itiPhone = window.intlTelInput(inputPhone, {
      separateDialCode: true,
      initialCountry: 'cn', // 初始国家
      nationalMode: false, // 不要插入国家拨号码
      separateDialCode: true, // 在选定的标记旁边显示国家拨号码，因此它不是键入编号的一部分
      utilsScript: "{$maccms.path_tpl}static/lib/intlTelInput/utils.js",
    });
    
    $('.jsTab').on('click', '.jsTabItem', function(){
      if($(this).hasClass('active')){
        return false;
      }

      $('.jsTabItem').removeClass('active');
      $(this).addClass('active');
      var type = $(this).attr('data-type');
      $('.jsWrap').hide();
      $('#login_'+ type).show();

    });

    
    $("input[name='user_name']").focus();
    // 账号登录
    $('#btn_submit').click(function(){
      var user_name = $('input[name="user_name"]').val();
      var user_pwd = $('input[name="user_pwd"]').val();
      var verify = $('input[name="verify"]').val();

      if(user_name==''){
        alert('账号不能为空');
        $('input[name="user_name"]').focus();
        return;
      }

      if(user_pwd==''){
        alert('密码不能为空');
        $('input[name="user_pwd"]').focus();
        return;
      }

      if($('input[name="verify"]').length>0 && verify==''){
        alert('验证码不能为空');
        $('input[name="verify"]').focus();
        return;
      }

      var data = {user_name:user_name, user_pwd:user_pwd, verify:verify };
      $.ajax({
        url: "{:url('user/login')}",
        type: "post",
        dataType: "json",
        data: data,
        beforeSend: function () {
          //开启loading
          //$(".loading_box").css("display","block");
          $("#btn_submit").css("background","#fd6a6a").val("loading...");
        },
        success: function (r) {
          if(r.code==1){
            location.href="{:url('user/index')}";
          }
          else{
            alert(r.msg);
            $('#verify_img').click();
          }
        },
        complete: function () {
          //结束loading
          //$(".loading_box").css("display","none");
          $("#btn_submit").css("background","#ff773c").val("登录");
        }
      });

    });

    // 手机号登录
    $('#btn_submit_phone').click(function(){
      var user_phone = $('input[name="user_phone"]').val();
      var user_pwd = $('input[name="user_phone_pwd"]').val();
      var verify = $('input[name="phone_verify"]').val();

      // 获取带区号的手机号码
      // var number = itiPhone.getNumber(intlTelInputUtils.numberFormat.E164);

      if(user_phone==''){
        alert('手机号不能为空');
        $('input[name="user_phone"]').focus();
        return;
      }
      // 校验国际区号对应的手机号格式是否正确
      var numberType = itiPhone.getNumberType();
      if (numberType !== intlTelInputUtils.numberType.MOBILE) {
          // isnot a mobile number
          console.log('isnot a mobile number')
          alert('输入的手机号格式和选择的国际区号不一致，请输入正确的手机号码')
          return false;
      }

      if(user_pwd==''){
        alert('密码不能为空');
        $('input[name="user_phone_pwd"]').focus();
        return;
      }

      if($('input[name="phone_verify"]').length>0 && verify==''){
        alert('验证码不能为空');
        $('input[name="phone_verify"]').focus();
        return;
      }

      var data = {user_phone:user_phone, user_pwd:user_pwd, verify:verify };
      $.ajax({
        url: "{:url('user/login')}",
        type: "post",
        dataType: "json",
        data: data,
        beforeSend: function () {
          //开启loading
          //$(".loading_box").css("display","block");
          $("#btn_submit_phone").css("background","#fd6a6a").val("loading...");
        },
        success: function (r) {
          if(r.code==1){
            location.href="{:url('user/index')}";
          }
          else{
            alert(r.msg);
            $('#verify_img_phone').click();
          }
        },
        complete: function () {
          //结束loading
          //$(".loading_box").css("display","none");
          $("#btn_submit_phone").css("background","#ff773c").val("登录");
        }
      });

    });

    


  </script>
</body>

</html>